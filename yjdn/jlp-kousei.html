<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テキスト解析WebAPI 校正支援デモ</title>
    <style>
      * { box-sizing: border-box; }
      body { margin: 0; padding: 0 1rem 2rem 1rem; }
      .section { margin-top: 1rem; }
      textarea { margin-top: 1rem; width: 100%; height: 8rem; font-size: large; }
      #output-view { border: dashed 2px gray; padding: 1rem; margin-top: 1rem; }
      del { background-color: #fcd; text-decoration: none; }
      ins { background-color: #bfb; text-decoration: none; color: gray; }
    </style>
    <script>
      const APPID = 'gUxspU.xg66pvU6W5OJMz0vH10FYB.FT4sWcQomZrtmPD6sG.14VlAuMdCGoBuIeMyOpRtlJBlc-';
      // APPID は動作確認用のものです。このファイルをDLして使う場合は自分で取得して設定してください
      // 手順: https://developer.yahoo.co.jp/start/

      async function kousei_webapi(text) {
          const url = 'https://jlp.yahooapis.jp/KouseiService/V2/kousei?appid=' + encodeURIComponent(APPID);
          return await fetch(url, {
              method: 'POST',
              body: JSON.stringify({
                  "id": "1234-1",
                  "jsonrpc" : "2.0",
                  "method" : "jlp.kouseiservice.kousei",
                  "params" : { "q" : text }
              }),
              mode: 'cors'
          }).then(res => res.json()).catch(console.error);
      }

      async function do_kousei() {
          const text = document.querySelector("#input-text").value;
          const obj = await kousei_webapi(text);
          if (!obj) return;
          make_html_view(text, obj);
          convert_html_view_to_text();
      }

      function make_html_view(text, obj) {
          [...obj.result.suggestions].reverse().forEach(s => {
              const pre = text.substring(0, parseInt(s.offset));
              const post = text.substring(parseInt(s.offset) + parseInt(s.length));
              text = pre + '<span title="' + s.rule + (s.note ? ' : ' + s.note : '') + '"><del>' + s.word +
                  '</del><ins contenteditable="true">' + (s.suggestion ? s.suggestion : s.word) +
                  '</ins><input type="checkbox"></span>' + post;
          });
          document.querySelector("#output-view").innerHTML = text.replaceAll('\n', '<br>\n');
          Array.from(document.querySelectorAll("#output-view span")).forEach(e => {
              e.querySelector('del').addEventListener('click', () =>
                  e.querySelector('input').checked && e.querySelector('input').click());
              e.querySelector('ins').addEventListener('click', () =>
                  e.querySelector('input').checked || e.querySelector('input').click());
              e.querySelector('ins').addEventListener('input', () => convert_html_view_to_text());
              e.querySelector('input').addEventListener('change', () => change_suggestion_style(e));
          });
      }

      function change_suggestion_style(e) {
          e.querySelector('del').style.color = e.querySelector('input').checked ? "gray" : "black";
          e.querySelector('ins').style.color = e.querySelector('input').checked ? "black" : "gray";
          convert_html_view_to_text();
      }

      function convert_html_view_to_text() {
          const tree = document.querySelector("#output-view").cloneNode(true);
          Array.from(tree.querySelectorAll('span')).forEach(e =>
              e.querySelector(e.querySelector('input').checked ? 'del' : 'ins').remove());
          document.querySelector("#output-text").value = tree.textContent;
      }

      function reset_checkboxes(checked) {
          Array.from(document.querySelectorAll('input[type="checkbox"]')).forEach(e => e.checked != checked && e.click());
      }
    </script>
  </head>
  <body>
    <h1>テキスト解析WebAPI 校正支援デモ</h1>
    <div class="section">
      <a target="_blank" href="https://developer.yahoo.co.jp/webapi/jlp/">テキスト解析 - Yahoo!デベロッパーネットワーク</a>
      の <a target="_blank" href="https://developer.yahoo.co.jp/webapi/jlp/kousei/v2/kousei.html">校正支援</a> のデモです。
    </div>
    <div class="section">
      <textarea id="input-text" placeholder="入力テキスト">矢張りセキュリティーで食べれるのかが問題なる。
しかし一週年記念で蟀谷が痛い。</textarea>
      <button onclick="do_kousei()">校正開始</button>
      <div id="output-view">出力操作パネル</div>
      <button onclick="reset_checkboxes(true)">一括承認</button>
      <button onclick="reset_checkboxes(false)">承認リセット</button>
      <textarea id="output-text" placeholder="出力テキスト"></textarea>
      <button onclick="navigator.clipboard.writeText(document.getElementById('output-text').value)">コピー</button>
    </div>
  </body>
</html>
